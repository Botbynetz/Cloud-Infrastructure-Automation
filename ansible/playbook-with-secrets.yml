---
# Example playbook demonstrating AWS Secrets Manager integration
# This shows how to fetch secrets dynamically at runtime

- name: Setup Web Server with Secrets Management
  hosts: all
  become: yes
  
  vars:
    # Fetch secrets from AWS Secrets Manager
    db_credentials: "{{ lookup('amazon.aws.aws_secret', 'database-credentials', region='ap-southeast-1') | from_json }}"
    api_key: "{{ lookup('amazon.aws.aws_secret', 'api-key', region='ap-southeast-1') }}"
  
  pre_tasks:
    - name: Install required Python packages for AWS integration
      pip:
        name:
          - boto3
          - botocore
        state: present
      tags:
        - setup
        - secrets

    - name: Verify AWS credentials are configured
      command: aws sts get-caller-identity
      register: aws_identity
      changed_when: false
      failed_when: aws_identity.rc != 0
      tags:
        - secrets
        - verify

  roles:
    - webserver
  
  post_tasks:
    - name: Configure application with secrets
      template:
        src: templates/app-config.j2
        dest: /etc/app/config.yml
        owner: www-data
        group: www-data
        mode: '0600'
      vars:
        db_host: "{{ db_credentials.host }}"
        db_port: "{{ db_credentials.port }}"
        db_user: "{{ db_credentials.username }}"
        db_password: "{{ db_credentials.password }}"
        app_api_key: "{{ api_key }}"
      tags:
        - config
        - secrets
      when: db_credentials is defined

    - name: Display deployment summary
      debug:
        msg:
          - "=========================================="
          - "Deployment completed successfully!"
          - "Environment: {{ environment }}"
          - "Website URL: http://{{ ansible_default_ipv4.address }}"
          - "Health Check: http://{{ ansible_default_ipv4.address }}/health"
          - "Secrets loaded from AWS Secrets Manager: âœ“"
          - "=========================================="
      tags:
        - always

